<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ctbench: ctbench</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ctbench<span id="projectnumber">&#160;1.3.4</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">ctbench </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_readme"></a> Compiler-assisted benchmarking for the study of C++ metaprogram compile times.</p>
<ul>
<li>Github project: <a href="https://github.com/jpenuchot/ctbench">https://github.com/jpenuchot/ctbench</a></li>
<li>Online documentation: <a href="https://jpenuchot.github.io/ctbench-docs/">https://jpenuchot.github.io/ctbench-docs/</a></li>
<li>Discord server: <a href="https://discord.gg/NvJFFrdS7p">https://discord.gg/NvJFFrdS7p</a></li>
</ul>
<p><a href="https://doi.org/10.21105/joss.05165"><img src="https://joss.theoj.org/papers/10.21105/joss.05165/status.svg" alt="DOI" style="pointer-events: none;" class="inline"/></a></p>
<p>ctbench allows you to declare and generate compile-time benchmark batches for given ranges, run them, aggregate and wrangle Clang profiling data, and plot them.</p>
<p>The project was made to fit the needs of <b>scientific data collection and analysis</b>, thus it is not a one-shot profiler, but a set of tools that enable <b>reproductible data gathering</b> from user-defined, variably sized compile-time benchmarks using Clang's time-trace feature to understand the impact of metaprogramming techniques on compile time. On top of that, ctbench is also able to measure compiler execution time to support compilers that do not have built-in profilers like GCC.</p>
<p>It has two main components: a C++ plotting toolset that can be used as a CLI program and as a library, and a CMake boilerplate library to generate benchmark and graph targets.</p>
<p>The CMake library contains all the boilerplate code to define benchmark targets compatible with the C++ plotting toolset called <code>grapher</code>.</p>
<p><a href="https://github.com/jpenuchot/rule-of-cheese">Rule of Cheese</a> can be used as an example project for using ctbench.</p>
<h3><a class="anchor" id="autotoc_md50"></a>
Examples</h3>
<p>As an example here are benchmark curves from the Poacher project. The benchmark case sources are available <a href="https://github.com/JPenuchot/poacher/tree/main/brainfog/benchmark/consecutive_loops">here</a>.</p>
<div class="image">
<object type="image/svg+xml" data="ExecuteCompiler.svg" style="pointer-events: none;"></object>
</div>
    <p><em>Clang ExecuteCompiler time curve from <a href="https://github.com/jpenuchot/poacher">poacher</a>, generated by the <code>compare_by</code> plotter</em></p>
<div class="image">
<object type="image/svg+xml" data="Total_Frontend.svg" style="pointer-events: none;"></object>
</div>
    <p><em>Clang Total Frontend time curve from <a href="https://github.com/jpenuchot/poacher">poacher</a>, generated by the <code>compare_by</code> plotter</em></p>
<h2><a class="anchor" id="autotoc_md51"></a>
Using ctbench</h2>
<h3><a class="anchor" id="autotoc_md52"></a>
Build prerequisites</h3>
<p>ArchLinux and Ubuntu 23.04 are officially supported as tests are compiled and executed on both of these Linux distributions. Others including Fedora or any other Linux distro that provides CMake 3.25 or higher should be compatible.</p>
<ul>
<li>Required ArchLinux packages: <code>boost boost-libs catch2 clang cmake curl fmt git llvm llvm-libs ninja nlohmann-json tar tbb unzip zip</code></li>
<li>Required Ubuntu packages: <code>catch2 clang cmake curl git libboost-all-dev libclang-dev libfmt-dev libllvm15 libtbb-dev libtbb12 llvm llvm-dev ninja-build nlohmann-json3-dev pkg-config tar unzip zip</code></li>
</ul>
<p>The Sciplot library is required too. It can be installed on ArchLinux using the <a href="https://aur.archlinux.org/packages/sciplot-git"><code>sciplot-git</code> AUR package</a> (NB: the non-git package isn't up-to-date). Otherwise, <a href="https://sciplot.github.io/installation/#installation-using-cmake">you can install it for your whole system using CMake</a> or locally using <a href="https://vcpkg.io/en/getting-started.html">vcpkg</a>:</p>
<div class="fragment"><div class="line">git clone https://github.com/Microsoft/vcpkg.git</div>
<div class="line">./vcpkg/bootstrap-vcpkg.sh</div>
<div class="line">./vcpkg/vcpkg install sciplot fmt</div>
<div class="line"> </div>
<div class="line">cmake --preset release \</div>
<div class="line">  -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake</div>
</div><!-- fragment --><p>Note: The <code>fmt</code> dependency is needed, as vcpkg breaks fmt's CMake integration if you have it already installed.</p>
<h3><a class="anchor" id="autotoc_md53"></a>
Installing ctbench</h3>
<div class="fragment"><div class="line">git clone https://github.com/jpenuchot/ctbench</div>
<div class="line">cd ctbench</div>
<div class="line">cmake --preset release</div>
<div class="line">cmake --build --preset release</div>
<div class="line">sudo cmake --build --preset release --target install</div>
</div><!-- fragment --><p>An <a href="https://aur.archlinux.org/packages/ctbench-git">AUR package</a> is available for easier install and update.</p>
<h3><a class="anchor" id="autotoc_md54"></a>
Integrating ctbench in your project</h3>
<p>ctbench can be integrated to a CMake project using <code>find_package</code>:</p>
<div class="fragment"><div class="line">find_package(ctbench REQUIRED)</div>
</div><!-- fragment --><p>The example project is provided as a reference project for ctbench integration and usage. For more details, an exhaustive <a href="https://jpenuchot.github.io/ctbench-docs/md_generated_docs_ctbench_api.html">CMake API reference</a> is available.</p>
<h3><a class="anchor" id="autotoc_md55"></a>
Declaring a benchmark case target</h3>
<p>A benchmark case is represented by a C++ file. It will be "instanciated", ie. compiled with <code>BENCHMARK_SIZE</code> defined to values in a range that you provide.</p>
<p><code>BENCHMARK_SIZE</code> is intended to be used by the preprocessor to generate a benchmark instance of the desired size:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;boost/preprocessor/repetition/repeat.hpp&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// First we generate foo&lt;int&gt;().</span></div>
<div class="line"><span class="comment">// foo&lt;int&gt;() uses C++20 requirements to dispatch function calls accross 16</span></div>
<div class="line"><span class="comment">// of its instances, according to the value of its integer template parameter.</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define FOO_MAX 16</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define DECL(z, i, nope)                                                       \</span></div>
<div class="line"><span class="preprocessor">  template &lt;int N&gt;                                                             \</span></div>
<div class="line"><span class="preprocessor">  requires(N % FOO_MAX == i) constexpr int foo() { return N * i; }</span></div>
<div class="line"> </div>
<div class="line">BOOST_PP_REPEAT(BENCHMARK_SIZE, DECL, FOO_MAX);</div>
<div class="line"><span class="preprocessor">#undef DECL</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Now we generate the sum() function for instanciation</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> sum() {</div>
<div class="line">  <span class="keywordtype">int</span> i;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define CALL(z, n, nop) i += foo&lt;n&gt;();</span></div>
<div class="line">  BOOST_PP_REPEAT(BENCHMARK_SIZE, CALL, i);</div>
<div class="line"><span class="preprocessor">#undef CALL</span></div>
<div class="line">  <span class="keywordflow">return</span> i;</div>
<div class="line">}</div>
</div><!-- fragment --><p>By default, only compiler execution time is measured. If you want to generate plots using Clang's profiler data, add the following:</p>
<div class="fragment"><div class="line">add_compile_options(-ftime-trace -ftime-trace-granularity=1)</div>
</div><!-- fragment --><p>Note that plotting profiler data takes more time and will generate a <em>lot</em> of plot files.</p>
<p>Then you can declare a benchmark case target in CMake with the following:</p>
<div class="fragment"><div class="line">ctbench_add_benchmark(function_selection.requires # Benchmark case name</div>
<div class="line">  function_selection-requires.cpp                 # Benchmark case file</div>
<div class="line">  1                                               # Range begin</div>
<div class="line">  32                                              # Range end</div>
<div class="line">  1                                               # Range step</div>
<div class="line">  10)                                             # Iterations per size</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md56"></a>
Declaring a graph target</h3>
<p>Once you have several benchmark cases, you can start writing a graph config.</p>
<p>Example configs can be found <a href="https://github.com/JPenuchot/ctbench/tree/main/grapher/configs">here</a>, or by running <code>ctbench-grapher-utils --plotter=&lt;plotter&gt; --command=get-default-config</code>. A list of available plotters can be retrieved by running <code>ctbench-grapher-utils --help</code>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;plotter&quot;: &quot;compare_by&quot;,</div>
<div class="line">  &quot;demangle&quot;: true,</div>
<div class="line">  &quot;draw_average&quot;: true,</div>
<div class="line">  &quot;draw_points&quot;: true,</div>
<div class="line">  &quot;key_ptrs&quot;: [</div>
<div class="line">    &quot;/name&quot;,</div>
<div class="line">    &quot;/args/detail&quot;</div>
<div class="line">  ],</div>
<div class="line">  &quot;legend_title&quot;: &quot;Timings&quot;,</div>
<div class="line">  &quot;plot_file_extensions&quot;: [</div>
<div class="line">    &quot;.svg&quot;,</div>
<div class="line">    &quot;.png&quot;</div>
<div class="line">  ],</div>
<div class="line">  &quot;value_ptr&quot;: &quot;/dur&quot;,</div>
<div class="line">  &quot;width&quot;: 1500,</div>
<div class="line">  &quot;height&quot;: 500,</div>
<div class="line">  &quot;x_label&quot;: &quot;Benchmark size factor&quot;,</div>
<div class="line">  &quot;y_label&quot;: &quot;Time (µs)&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><p>This configuration uses the <code>compare_by</code> plotter. It compares features targeted by the JSON pointers in <code>key_ptrs</code> across all benchmark cases. This is the easiest way to extract and compare as many relevant time-trace features at once.</p>
<p>Back to CMake, you can now declare a graph target using this config to compare the time spent in the compiler execution, the frontend, and the backend between the benchmark cases you declared previously:</p>
<div class="fragment"><div class="line">ctbench_add_graph(function_selection-feature_comparison-graph # Target name</div>
<div class="line">  ${CONFIGS}/feature_comparison.json                          # Config</div>
<div class="line">  function_selection.enable_if                                # First case</div>
<div class="line">  function_selection.enable_if_t                              # Second case</div>
<div class="line">  function_selection.if_constexpr                             # ...</div>
<div class="line">  function_selection.control</div>
<div class="line">  function_selection.requires)</div>
</div><!-- fragment --><p>For each group descriptor, a graph will be generated with one curve per benchmark case. In this case, you would then get 3 graphs (<code>ExecuteCompiler</code>, <code>Frontend</code>, and <code>Backend</code>) each with 5 curves (<code>enable_if</code>, <code>enable_if_t</code>, <code>if_constexpr</code>, <code>control</code>, and <code>requires</code>).</p>
<h2><a class="anchor" id="autotoc_md57"></a>
Related work</h2>
<ul>
<li><a href="https://github.com/jpenuchot/poacher">poacher</a></li>
<li><a href="https://github.com/jpenuchot/rule-of-cheese">Rule of Cheese</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md58"></a>
References</h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=1RZY6skM0Rc">ctbench: compile time benchmarking for Clang</a> at <a href="https://cppp.fr/schedule2021/">CPPP 2021</a></li>
<li><a href="https://www.youtube.com/watch?v=ekFPm7e__vI">A totally constexpr standard library - Paul Keir, Joel Falcou et al - Meeting C++ 2022</a></li>
<li><a href="https://pyperf.readthedocs.io/en/latest/system.html">Pyperf - Tune the system for benchmarks</a></li>
<li><a href="https://github.com/ldionne/metabench">Metabench</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md59"></a>
Citing ctbench</h2>
<div class="fragment"><div class="line">@article{Penuchot2023,</div>
<div class="line">  doi = {10.21105/joss.05165},</div>
<div class="line">  url = {https://doi.org/10.21105/joss.05165},</div>
<div class="line">  year = {2023},</div>
<div class="line">  publisher = {The Open Journal},</div>
<div class="line">  volume = {8},</div>
<div class="line">  number = {88},</div>
<div class="line">  pages = {5165},</div>
<div class="line">  author = {Jules Penuchot and Joel Falcou},</div>
<div class="line">  title = {ctbench - compile-time benchmarking and analysis},</div>
<div class="line">  journal = {Journal of Open Source Software},</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
